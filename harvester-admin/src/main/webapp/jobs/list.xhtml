<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"   
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ez="http://java.sun.com/jsf/composite/poll">
  <h:body>

    <ui:composition template="/templates/master.xhtml">
      <ui:param name="title" value="Harvest Jobs" />
      <ui:define name="content">
        <h:form>
          <h:outputText value="Add new harvest job: " />
          <h:commandLink styleClass="navigation" value="OAI-PMH"
                         action="#{resourceController.prepareOaiPmhResourceToAdd}" />
          <h:outputText value=", " />
          <h:commandLink styleClass="navigation" value="XML/MARC bulk"
                         action="#{resourceController.prepareXmlBulkResourceToAdd}" />
          <h:outputText value=", "/>
          <h:commandLink styleClass="navigation" value="Connector" 
                         action="#{resourceController.prepareConnectorResourceToAdd}" />       
<!--
          <h:outputText value=", "/>
          <h:commandLink styleClass="navigation" value="WebCrawl" 
                         action="#{resourceController.prepareWebCrawlResourceToAdd}" />       
-->
        </h:form>
        <h:panelGroup id="autoCheckbox">
          <h:selectBooleanCheckbox value="true" 
            onchange="window.autoUpdate = this.checked;" >Auto-update</h:selectBooleanCheckbox>
        </h:panelGroup>
        <h:form id="jobForm"> 
          <h:panelGroup id="jobTable">
            <div id="pager">
              <h:panelGroup id="pagerPanel">
              <h:outputText
                value="Item #{resourceController.firstItem + 1}..#{resourceController.lastItem} of #{resourceController.itemCount}" />
              &nbsp;
              <h:commandLink
                             action="#{resourceController.prev}"
                             value="Previous"
                             rendered="#{resourceController.firstItem &gt;= resourceController.batchSize}" >
                <f:ajax render="jobForm:pagerPanel jobForm:jobList" />
              </h:commandLink>
              &nbsp;
              <h:commandLink
                             action="#{resourceController.next}"
                             value="Next"
                             rendered="#{resourceController.lastItem  &lt; resourceController.itemCount}" >
                <f:ajax render="jobForm:pagerPanel jobForm:jobList" />
              </h:commandLink>
              </h:panelGroup>
            </div>
            <h:dataTable id="jobList" width="100%" value="#{resourceController.resources}"
                         var="item"
                         columnClasses="resourcename,status,lastharvest,amountharvest,nextharvest,actions,statusmessage"
                         styleClass="harvestjobs">
              <h:column headerClass="resourcename">
                <f:facet name="header">
                  <h:commandLink action="#{resourceController.sortByName}">
                    <h:outputText value="&#187;" 
                                  rendered="#{resourceController.sortKey == 'name'}" />
                    <h:outputText value="Name"/>
                    <h:outputText value="&#8595;" rendered="#{resourceController.sortKey == 'name' and resourceController.descending}" />
                    <f:ajax render=":jobForm:jobList"/>
                  </h:commandLink>
                </f:facet>
                <h:outputText value="#{item.name}"></h:outputText>
              </h:column>
              <h:column headerClass="status">
                <f:facet name="header">
                  <h:commandLink action="#{resourceController.sortByStatus}">
                    <h:outputText value="&#187;" 
                                  rendered="#{resourceController.sortKey == 'currentStatus'}" />
                    <h:outputText value="Status"/>
                    <h:outputText value="&#8595;" 
                                  rendered="#{resourceController.sortKey == 'currentStatus' and resourceController.descending}" />
                    <f:ajax render=":jobForm:jobList"/>
                  </h:commandLink>
                </f:facet>
                <h:outputText value="#{item.currentStatus}"></h:outputText>
              </h:column>
              <h:column headerClass="lastharvest">
                <f:facet name="header">
                  <h:commandLink action="#{resourceController.sortByLastHarvest}">
                    <h:outputText value="&#187;" 
                                  rendered="#{resourceController.sortKey == 'lastHarvestStartedOrFinished'}" />
                    <h:outputText value="Last harvested"/>
                    <h:outputText value="&#8595;" rendered="#{resourceController.sortKey == 'lastHarvestStartedOrFinished' and resourceController.descending}" />
                    <f:ajax render=":jobForm:jobList"/>
                  </h:commandLink>
                </f:facet>
                <h:outputText rendered="#{item.lastHarvestFinished != null}"
                              value="#{item.lastHarvestFinished}">
                  <f:convertDateTime pattern="yyyy-MM-dd HH:mm z" />
                </h:outputText>
                <h:outputText styleClass="attempt"
                              rendered="#{item.lastHarvestFinished == null}"
                              value="#{item.lastHarvestStarted}">
                  <f:convertDateTime pattern="yyyy-MM-dd HH:mm z" />
                </h:outputText>
              </h:column>
              <h:column headerClass="amountharvest">
                <f:facet name="header">
                    <h:outputText value="Last count"/>
                </f:facet>
                <h:outputText styleClass="amountharvest"
                              rendered="#{item.amountHarvested != null}"
                              value="#{item.amountHarvested}">
                </h:outputText>
                <h:outputText styleClass="amountharvest"
                              rendered="#{item.amountHarvested == null}"
                              value="">
                </h:outputText>       
              </h:column>
              <h:column headerClass="nextharvest">
                <f:facet name="header">
                    <h:outputText value="Next harvest"/>
                </f:facet>
                <h:outputText rendered="#{item.enabled}"
                              value="#{item.nextHarvestSchedule}">
                  <f:convertDateTime pattern="yyyy-MM-dd HH:mm z" />
                </h:outputText>
                <h:outputText rendered="#{!item.enabled }"
                              value="Disabled">
                </h:outputText>
              </h:column>
              <h:column headerClass="actions">
                <f:facet name="header">
                  <h:outputText value="Actions" />
                </f:facet>
                <h:commandLink styleClass="action"
                               action="#{resourceController.prepareResourceToEdit}">
                  <f:param name="resourceId" value="#{item.id}" />
                  <h:graphicImage title="Edit" alt="Edit" height="16" url="/images/edit.png" />
                </h:commandLink>
                <h:commandLink styleClass="action"
                               action="#{resourceController.prepareResourceToRun}"
                               rendered="#{!item.running}">
                  <f:ajax render=":jobForm:jobTable"/> 
                  <f:param name="resourceId" value="#{item.id}" />
                  <h:graphicImage title="Run" alt="Run" height="16" url="/images/run.png" />
                </h:commandLink>
                <h:commandLink styleClass="action"
                               action="#{resourceController.prepareResourceToRun}"
                               rendered="#{item.running}">
                  <f:ajax render=":jobForm:jobTable"/> 
                  <f:param name="resourceId" value="#{item.id}" />
                  <f:param name="action" value="stop" />
                  <h:graphicImage title="Stop" alt="Stop" height="16" url="/images/stop.png" />
                </h:commandLink>
                <h:commandLink styleClass="action"
                               action="#{resourceController.viewJobLog}">
                  <f:param name="resourceId" value="#{item.id}" />
                  <h:graphicImage title="View Log" alt="View Log" height="16" url="/images/log.png" />
                </h:commandLink>
                <h:commandLink styleClass="action"
                               action="#{resourceController.deleteResource}"
                               onclick="return confirm('Are you sure?');">
                  <f:ajax render=":jobForm:jobTable"/> 
                  <f:param name="resourceId" value="#{item.id}" />
                  <h:graphicImage title="Delete" alt="Delete" height="16" url="/images/delete.png" />
                </h:commandLink>
              </h:column>
              <h:column headerClass="statusmessage">
                <f:facet name="header">
                  <h:outputText value="Status Message" />
                </f:facet>
                <h:outputText value="#{item.message}"></h:outputText>
              </h:column>
            </h:dataTable>
            <ez:poll id="poll" interval="5000" timeout="3000" render="jobForm:jobList"/>
          </h:panelGroup>
        </h:form>
      </ui:define>
    </ui:composition>

  </h:body>

</html>
